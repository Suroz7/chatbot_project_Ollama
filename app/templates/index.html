<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
   
</head>
<body>
    <div class="container">
        <header>
            <h1>Chat with AI</h1>
            <button id="dark-toggle">ðŸŒ™</button>
        </header>
        <div id="chat-box"></div>
        <div class="input-area">
            <div class="chat-controls">
                <button onclick="downloadChat()" class="control-button">Download Chat History</button>
                <button onclick="clearChat()" class="control-button">Clear Chat</button>
            </div>
            <input type="text" id="prompt" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Load message history on page load
       // window.onload = function() {
         //   const chatBox = document.getElementById('chat-box');
       //     const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
        //    history.forEach((msg) => {
        //        const p = document.createElement('p');
         //       p.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}`;
        //        p.classList.add('message');
        //        chatBox.appendChild(p);
       //     });
     //   };

        // Dark mode toggle logic
        document.getElementById('dark-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.getElementById('chat-box').classList.toggle('dark-mode');
            document.getElementById('prompt').classList.toggle('dark-mode');
            [...document.getElementsByTagName('button')].forEach(btn => btn.classList.toggle('dark-mode'));
        });

        // Update message creation to use message bubbles
        function createMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender.toLowerCase());
            msgDiv.innerHTML = `<p>${text}</p>`;
            return msgDiv;
        }
     
        async function sendMessage() {
            const promptInput = document.getElementById('prompt');
            const prompt = promptInput.value;
            const chatBox = document.getElementById('chat-box');

            // Don't send empty messages
            if (!prompt.trim()) return;

            const userMsg = createMessage('You', prompt);
            chatBox.appendChild(userMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Save user message to local storage (for UI persistence only)
            let history = JSON.parse(localStorage.getItem("chatHistory")) || [];
            history.push({ sender: "You", text: prompt });
            localStorage.setItem("chatHistory", JSON.stringify(history));

            const aiMsg = createMessage('AI', '');
            chatBox.appendChild(aiMsg);
            
            try {
                const eventSource = new EventSource(`/api/chat/stream?prompt=${encodeURIComponent(prompt)}`);
                let fullResponse = '';
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.chunk) {
                        fullResponse += data.chunk;
                        aiMsg.innerHTML = `<p>${fullResponse}</p>`;
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                };

                eventSource.onerror = function(error) {
                    eventSource.close();
                    // Save AI response to local storage
                    if (fullResponse) {
                        history = JSON.parse(localStorage.getItem("chatHistory")) || [];
                        history.push({ sender: "AI", text: fullResponse });
                        localStorage.setItem("chatHistory", JSON.stringify(history));
                    }
                };
                
            } catch (error) {
                aiMsg.innerHTML = `<p>Error: ${error.message}</p>`;
            }

            promptInput.value = '';
        }

        // Allow Enter key to send message
        document.getElementById('prompt').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function clearChat() {
            if (!confirm('Warning: This will permanently delete all conversation history. Are you sure?')) {
                return;
            }

            fetch('/api/chat/clear', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('chat-box').innerHTML = '';
                    // Clear localStorage
                    localStorage.removeItem("chatHistory");
                    // Show warning message
                    const warningMsg = createMessage('System', 'All conversation history has been permanently deleted.');
                    document.getElementById('chat-box').appendChild(warningMsg);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        function downloadChat() {
    fetch('/api/chat/download')
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_history.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        })
        .catch(error => console.error('Error downloading chat:', error));
}
    </script>
</body>
</html>